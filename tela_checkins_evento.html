<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Check-ins do Evento</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        padding: 20px;
        position: relative;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
      }

      h2 {
        text-align: center;
        color: #555;
        margin-bottom: 20px;
      }

      .checkin-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .checkin-item {
        background: #f9f9f9;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      .checkin-item:hover {
        transform: translateY(-5px);
      }

      .checkin-item .name {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }

      .checkin-item span {
        display: block;
        font-size: 0.9em;
        color: #555;
      }

      #noCheckinsMessage {
        text-align: center;
        color: #666;
        font-size: 1em;
        margin-top: 20px;
      }

      .btn-downloads {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-back {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        color: #fff;
        background-color: red;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-pdf {
        background-color: #007bff;
        color: #fff;
        border: none;
      }

      .btn-pdf:hover {
        background-color: #0056b3;
      }

      .btn-excel {
        background-color: #28a745;
        color: #fff;
        border: none;
      }

      .btn-excel:hover {
        background-color: #218838;
      }

      .btn-downloads i {
        font-size: 18px;
      }

      .version-label {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

      async function fetchFirebaseConfig() {
        const response = await fetch("firebase-config.json");
        return response.json();
      }

      (async () => {
        const firebaseConfig = await fetchFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get("eventId");

        if (!eventId) {
          alert("ID do evento não fornecido. Redirecionando...");
          window.location.href = "telaintermediaria.html";
          return;
        }

        const checkinList = document.getElementById("checkinList");
        const eventNameElement = document.getElementById("eventName");
        const checkins = [];
        let nomeDoEvento = "";

        async function loadCheckins() {
          try {
            const q = query(
              collection(db, "checkins"),
              where("eventId", "==", eventId)
            );
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
              const noCheckinsMessage = document.createElement("p");
              noCheckinsMessage.id = "noCheckinsMessage";
              noCheckinsMessage.textContent =
                "Nenhum check-in registrado para este evento.";
              checkinList.appendChild(noCheckinsMessage);
            }

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              checkins.push(data);

              const item = document.createElement("div");
              item.classList.add("checkin-item");
              item.innerHTML = `
                <div class="name">${data.nomeCompleto}</div>
                <span><strong>CPF:</strong> ${data.cpf}</span>
                <span><strong>Telefone:</strong> ${data.telefone}</span>
                <span><strong>Email:</strong> ${data.email}</span>
              `;
              checkinList.appendChild(item);
            });
          } catch (error) {
            console.error("Erro ao carregar check-ins:", error);
          }
        }

        async function loadEventName() {
          try {
            const eventDoc = await getDoc(doc(db, "eventos", eventId));
            if (eventDoc.exists()) {
              nomeDoEvento = eventDoc.data().nome;
              eventNameElement.textContent = nomeDoEvento;
            } else {
              eventNameElement.textContent = "Evento não encontrado";
            }
          } catch (error) {
            console.error("Erro ao carregar o nome do evento:", error);
          }
        }

        await loadEventName();
        await loadCheckins();

        window.downloadPDF = function () {
          if (checkins.length === 0) {
            alert("Não é possível baixar o arquivo porque não houve check-in.");
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFont("Arial", "B", 16);
          doc.text("Lista de Participantes", 10, 10);

          // Cabeçalho da tabela
          doc.setFont("Arial", "B", 12);
          doc.text("Nome", 10, 20);
          doc.text("CPF", 60, 20);
          doc.text("Telefone", 100, 20);
          doc.text("Email", 140, 20);
          doc.setLineWidth(0.5);
          doc.line(10, 22, 200, 22); // Linha horizontal

          let y = 30; // Começar logo após a linha
          const marginBottom = 10;

          checkins.forEach((item, index) => {
            if (y >= 270) {
              // Nova página se necessário
              doc.addPage();
              y = 20;
            }

            doc.setFont("Arial", "I", 10);
            doc.text(item.nomeCompleto, 10, y);
            doc.text(item.cpf, 60, y);
            doc.text(item.telefone, 100, y);
            doc.text(item.email, 140, y);
            y += 10;
          });

          doc.save(`${nomeDoEvento}.pdf`);
        };

        window.downloadExcel = function () {
          if (checkins.length === 0) {
            alert("Não é possível baixar o arquivo porque não houve check-in.");
            return;
          }

          const ws = XLSX.utils.json_to_sheet(checkins);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Check-ins");
          XLSX.writeFile(wb, `${nomeDoEvento}.xlsx`);
        };
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <h1>Check-ins do Evento</h1>
      <h2 id="eventName">Carregando nome do evento...</h2>
      <div class="btn-downloads">
        <button class="btn-pdf" onclick="downloadPDF()">
          <i class="fas fa-file-pdf"></i> Baixar em PDF
        </button>
        <button class="btn-excel" onclick="downloadExcel()">
          <i class="fas fa-file-excel"></i> Baixar em Excel
        </button>
        <button
          class="btn-back"
          onclick="window.location.href='telaintermediaria.html'"
        >
          Voltar
        </button>
      </div>
      <div id="checkinList"></div>
      <div class="version-label">Versão 1.2</div>
    </div>
  </body>
</html>
