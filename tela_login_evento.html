<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tela de Login do Evento</title>
    <style>
      /* Estilos mantidos */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f0f0f5;
      }

      .container {
        width: 90%;
        max-width: 400px;
        background-color: #ffffff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .event-info {
        text-align: center;
        margin-bottom: 20px;
      }

      form {
        display: flex;
        flex-direction: column;
      }

      form label {
        margin-top: 10px;
        font-size: 0.9em;
        color: #333;
      }

      form input {
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9em;
      }

      form button {
        margin-top: 20px;
        padding: 10px;
        border: none;
        background-color: #007bff;
        color: #fff;
        border-radius: 4px;
        font-size: 1em;
        cursor: pointer;
      }

      form button:hover {
        background-color: #0056b3;
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        doc,
        getDoc,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

      async function fetchFirebaseConfig() {
        const response = await fetch("firebase-config.json");
        return response.json();
      }

      (async () => {
        const firebaseConfig = await fetchFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get("eventId");

        if (!eventId) {
          alert(
            "ID do evento não fornecido. Redirecionando para a tela inicial."
          );
          window.location.href = "index.html";
          return;
        }

        try {
          const eventDoc = await getDoc(doc(db, "eventos", eventId));
          if (!eventDoc.exists()) {
            alert("Evento não encontrado. Redirecionando para a tela inicial.");
            window.location.href = "index.html";
            return;
          }

          const eventData = eventDoc.data();
          document.querySelector(".event-info h1").innerText = eventData.nome;
          document.querySelector(
            ".event-info p:nth-child(2)"
          ).innerText = `Data: ${new Date(
            eventData.dataHora
          ).toLocaleString()}`;
          document.querySelector(
            ".event-info p:nth-child(3)"
          ).innerText = `Local: ${eventData.endereco}, ${eventData.numero}, ${eventData.cidade}`;
          document.querySelector(
            ".event-info p:nth-child(4)"
          ).innerText = `Descrição: ${eventData.descricao}`;
        } catch (error) {
          console.error("Erro ao carregar os detalhes do evento:", error);
          alert(
            "Erro ao carregar os detalhes do evento. Tente novamente mais tarde."
          );
          window.location.href = "index.html";
        }

        function formatInput(input, pattern) {
          let i = 0;
          const onlyNumbers = input.replace(/\D/g, "");
          const formatted = pattern.replace(/#/g, () => onlyNumbers[i++] || "");
          return formatted;
        }

        function handleInput(event, pattern) {
          const input = event.target;
          const cursorPosition = input.selectionStart;
          const oldValue = input.value;
          const onlyNumbers = oldValue.replace(/\D/g, "");

          if (event.inputType === "deleteContentBackward") {
            input.value = formatInput(onlyNumbers.slice(0, -1), pattern);
          } else {
            input.value = formatInput(onlyNumbers, pattern);
          }

          const newCursorPosition =
            cursorPosition - (oldValue.length - input.value.length);
          input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        document.getElementById("cpf").addEventListener("input", (e) => {
          handleInput(e, "###.###.###-##");
        });

        document.getElementById("telefone").addEventListener("input", (e) => {
          handleInput(e, "(##) #####-####");
        });

        document
          .getElementById("login-form")
          .addEventListener("submit", async function (event) {
            event.preventDefault();

            const nomeCompleto = document
              .getElementById("nome-completo")
              .value.trim();
            const cpf = document.getElementById("cpf").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            const email = document.getElementById("email").value.trim();

            if (!nomeCompleto || !cpf || !telefone || !email) {
              alert("Por favor, preencha todos os campos corretamente.");
              return;
            }

            const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
            if (!emailPattern.test(email)) {
              alert("Por favor, insira um email válido.");
              return;
            }

            try {
              const checkQuery = query(
                collection(db, "checkins"),
                where("eventId", "==", eventId),
                where("cpf", "==", cpf)
              );

              const checkSnapshot = await getDocs(checkQuery);
              if (!checkSnapshot.empty) {
                alert("CPF já registrado para este evento.");
                return;
              }

              await addDoc(collection(db, "checkins"), {
                eventId: eventId,
                nomeCompleto: nomeCompleto,
                cpf: cpf,
                telefone: telefone,
                email: email,
                checkInTime: serverTimestamp(),
              });

              alert("Check-in realizado com sucesso!");
              document.getElementById("login-form").reset();
            } catch (error) {
              console.error("Erro ao realizar o check-in: ", error);
              alert("Erro ao realizar o check-in. Tente novamente.");
            }
          });
      })();
    </script>
  </head>
  <body>
    <div class="container">
      <div class="event-info">
        <h1>Carregando...</h1>
        <p>Carregando...</p>
        <p>Carregando...</p>
        <p>Carregando...</p>
      </div>
      <form id="login-form">
        <label for="nome-completo">Nome Completo:</label>
        <input type="text" id="nome-completo" name="nome-completo" required />

        <label for="cpf">CPF:</label>
        <input
          type="text"
          id="cpf"
          name="cpf"
          required
          placeholder="000.000.000-00"
        />

        <label for="telefone">Número de Telefone:</label>
        <input
          type="text"
          id="telefone"
          name="telefone"
          required
          placeholder="(00) 00000-0000"
        />

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required />

        <button type="submit">Entrar</button>
      </form>
    </div>
  </body>
</html>
